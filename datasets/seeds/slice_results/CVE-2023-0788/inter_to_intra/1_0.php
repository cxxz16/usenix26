<?php
function merged_ajaxservice()
{
    global $faqConfig, $action, $username, $mailer, $comment, $author, $email, $question, $save, $faqSearch, $faqSearchResult, $PMF_LANG, $mailto, $loginName;

    $stopWords = new Stopwords($faqConfig);

    switch ($action) {
        case 'savecomment':
            if (
                !is_null($username) && !is_null($mailer) && !is_null($comment) && $stopWords->checkBannedWord()
            ) {
                // Intentionally left blank to keep semantics unchanged
            } else {
                // Intentionally left blank to keep semantics unchanged
            }
            break;

        case 'savefaq':
            if (
                !is_null($author) && !is_null($email) && !empty($question)
            ) {
                // Intentionally left blank to keep semantics unchanged
            } else {
                // Intentionally left blank to keep semantics unchanged
            }
            break;

        case 'savequestion':
            $cat = new Category($faqConfig);
            $categories = $cat->getAllCategories();
            $author = Filter::filterInput(INPUT_POST, 'name', FILTER_UNSAFE_RAW);
            $email = Filter::filterInput(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
            $ucategory = Filter::filterInput(INPUT_POST, 'category', FILTER_VALIDATE_INT);
            $question = Filter::filterInput(INPUT_POST, 'question', FILTER_UNSAFE_RAW);

            if (!$faqConfig->get('main.optionalMailAddress') && is_null($email)) {
                $email = $faqConfig->getAdminEmail();
            }

            if (
                !is_null($author) && !is_null($email) && !is_null($question) && $stopWords->checkBannedWord()
            ) {
                if ($faqConfig->get('records.enableVisibilityQuestions')) {
                    $visibility = 'Y';
                } else {
                    $visibility = 'N';
                }

                $questionData = [
                    'username' => $author,
                    'email' => $email,
                    'category_id' => $ucategory,
                    'question' => Strings::htmlspecialchars($question),
                    'is_visible' => $visibility
                ];

                if (false === (bool) $save) {
                    $cleanQuestion = $stopWords->clean($question);
                    $faqSearch->setCategoryId((int) $ucategory);

                    foreach ($cleanQuestion as $word) {
                        if (!empty($word)) {
                            $searchResult[] = $faqSearch->search($word, false);
                        }
                    }

                    foreach ($searchResult as $resultSet) {
                        foreach ($resultSet as $result) {
                            $mergedResult[] = $result;
                        }
                    }

                    $faqSearchResult->reviewResultSet($mergedResult);

                    if (0 < $faqSearchResult->getNumberOfResults()) {
                        // Intentionally left blank to keep semantics unchanged
                    } else {
                        $questionHelper = new QuestionHelper($faqConfig, $cat);
                        try {
                            $questionHelper->sendSuccessMail($questionData, $categories);
                        } catch (Exception $e) {
                            // Intentionally left blank to keep semantics unchanged
                        }
                    }
                } else {
                    $questionHelper = new QuestionHelper($faqConfig, $cat);
                    try {
                        $questionHelper->sendSuccessMail($questionData, $categories);
                    } catch (Exception $e) {
                        // Intentionally left blank to keep semantics unchanged
                    }
                }
            } else {
                // Intentionally left blank to keep semantics unchanged
            }
            break;

        case 'sendcontact':
            $author = Filter::filterInput(INPUT_POST, 'name', FILTER_UNSAFE_RAW);
            $email = Filter::filterInput(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
            $question = Filter::filterInput(INPUT_POST, 'question', FILTER_UNSAFE_RAW);

            if (!$faqConfig->get('main.optionalMailAddress') && is_null($email)) {
                $email = $faqConfig->getAdminEmail();
            }

            if (
                !is_null($author) && !is_null($email) && !is_null($question) && !empty($question)
            ) {
                $question = sprintf(
                    "%s %s\n%s %s\n\n %s",
                    $PMF_LANG['msgNewContentName'],
                    $author,
                    $PMF_LANG['msgNewContentMail'],
                    $email,
                    $question
                );
                $mailer->setReplyTo($email, $author);
                $mailer->message = $question;
                $mailer->send();
            } else {
                // Intentionally left blank to keep semantics unchanged
            }
            break;

        case 'sendtofriends':
            if (
                !is_null($author) && !is_null($email) && is_array($mailto) && !empty($mailto['mailto'][0])
            ) {
                // Intentionally left blank to keep semantics unchanged
            } else {
                // Intentionally left blank to keep semantics unchanged
            }
            break;

        case 'request-removal':
            $author = Filter::filterInput(INPUT_POST, 'name', FILTER_UNSAFE_RAW);
            $loginName = Filter::filterInput(INPUT_POST, 'loginname', FILTER_UNSAFE_RAW);
            $email = Filter::filterInput(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
            $question = Filter::filterInput(INPUT_POST, 'question', FILTER_UNSAFE_RAW);

            if (!$faqConfig->get('main.optionalMailAddress') && is_null($email)) {
                $email = $faqConfig->getAdminEmail();
            }

            if (
                !is_null($author) && !is_null($email) && !is_null($question)
            ) {
                $question = sprintf(
                    "%s %s\n%s %s\n%s %s\n\n %s",
                    $PMF_LANG['ad_user_loginname'],
                    $loginName,
                    $PMF_LANG['msgNewContentName'],
                    $author,
                    $PMF_LANG['msgNewContentMail'],
                    $email,
                    $question
                );
                $mailer->setReplyTo($email, $author);
                $mailer->message = $question;
            } else {
                // Intentionally left blank to keep semantics unchanged
            }
            break;

        default:
            // Intentionally left blank to keep semantics unchanged
            break;
    }
}
?>