<?php
// Call Relations: []

// File: actions/newtextsearch.php

// Scope: Global Scope

function newtextsearch($config, $services) {
    $phrase = GetParameter('phrase', false);
    $prefixe = $config['table_prefix'];
    $user = GetUser();
    $paramPhrase = htmlspecialchars($phrase, ENT_COMPAT, YW_CHARSET);
    if (!$phrase && isset($_GET['phrase'])) {
        $phrase = htmlspecialchars($_GET['phrase'], ENT_COMPAT, YW_CHARSET);
    }
    if (!$paramPhrase) {
        echo '<div class="input-prepend input-append input-group input-group-lg">
              <span class="add-on input-group-addon"><i class="fa fa-search icon-search"></i></span>
              <input name="phrase" type="text" class="form-control" placeholder="'.(($label) ? $label : '').'" size="', $size, '" value="', $phrase, '" >
              <span class="input-group-btn">
              <input type="submit" class="btn btn-primary btn-lg" value="', $button, '" />
              </span>
              </div>
              <span class="">
              <small>Un caract&eacute;re inconnu peut &ecirc;tre remplac&eacute; par « ? » plusieurs par « * »</small>
              </span><!-- /input-group --><br>';
    }
    if ($phrase) {
        $formManager = $services->get(FormManager::class);
        $forms = $formManager->getAll();
        $searchManager = $services->get(SearchManager::class);
        $needles = $searchManager->searchWithLists(str_replace(array('*', '?'), array('', '_'), $phrase), $forms);
        $requeteSQLForList = '';
        if (!empty($needles)) {
            foreach ($needles as $needle => $results) {
                if (!empty($results)) {
                    if ($first) {
                    } else {
                        $requeteSQLForList .= ' AND ';
                    }
                    $requeteSQLForList .= '(';
                    $requeteSQLForList .= 'body REGEXP \''.$needle.'\'';
                    foreach ($results as $result) {
                        $requeteSQLForList .= ' OR ';
                        if (!$result['isCheckBox']) {
                            $requeteSQLForList .= ' body LIKE \'%"'.str_replace('_', '\\_', $result['propertyName']).'":"'.$result['key'].'"%\'';
                        } else {
                            $requeteSQLForList .= ' body REGEXP \'"'.str_replace('_', '\\_', $result['propertyName']).'":(' .
                                '"'.$result['key'] . '"'.
                                '|"[^"]*,' . $result['key'] . '"'.
                                '|"' . $result['key'] . ',[^"]*"'.
                                '|"[^"]*,' .$result['key'] . ',[^"]*"'.
                                ')\'';
                        }
                    }
                    $requeteSQLForList .= ')';
                }
            }
        }
        if (!empty($requeteSQLForList)) {
            $requeteSQLForList = ' OR ('.$requeteSQLForList.') ';
        }
        $phraseFormatted= str_replace(array('*', '?'), array('%', '_'), $phrase);
        $phraseFormatted = addslashes($phraseFormatted);
        $requestfull = 'SELECT body, tag FROM '.$prefixe.'pages
                      LEFT JOIN '.$prefixe.'acls ON tag = page_tag AND privilege = "read"
                      WHERE latest = "Y"
                      AND ( list IS NULL OR list ="*" '.
                      ($user ? 'OR owner = "'.$user['name'].'" OR list = "+" OR (list NOT LIKE "%!'.$user['name'].'%" AND list LIKE "%'.$user['name'].'")':'').')'.
                      // TODO retrouver la facon d'afficher les commentaires (AFFICHER_COMMENTAIRES ? '':'AND tag NOT LIKE "comment%"').
                      ' AND body LIKE "%' . $phraseFormatted . '%"'.$requeteSQLForList.'
                      GROUP BY tag ORDER BY tag LIMIT 100';
        if ($resultat = LoadAll($requestfull)) {
        } else {
        }
    }
}