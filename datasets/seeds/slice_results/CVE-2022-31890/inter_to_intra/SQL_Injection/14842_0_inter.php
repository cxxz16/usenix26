<?php
function merged_audit_function() {
    // Move actual arguments from caller into callee
    // From template: AuditEntry::getQwhere($ticketId, false, 'T');
    $objectId = $ticketId;
    $hide_views = false;
    $type = 'T';

    // Begin implementation merged from getQwhere
    $qwhere = '';
    $class = 'AuditEntry';

    switch ($class) {
        case 'AuditEntry':
            $qwhere .= ' AND object_type=' . db_input($_REQUEST['type'] ?: 'D');
            if ($hide_views) {
                $qwhere .= ' AND event_id=' . db_input(Event::getIdByName($_REQUEST['state']));
            }
            if ($_REQUEST['state'] && $_REQUEST['state'] != __('All')) {
                $event_id = Event::getIdByName(lcfirst($_REQUEST['state']));
                $qwhere .= ' AND event_id=' . db_input($event_id);
            }
            $startTime = ($_REQUEST['startDate'] && (strlen($_REQUEST['startDate']) >= 8)) ? strtotime($_REQUEST['startDate']) : 0;
            $endTime = ($_REQUEST['endDate'] && (strlen($_REQUEST['endDate']) >= 8)) ? strtotime($_REQUEST['endDate']) : 0;
            if (($startTime && $startTime > time()) or ($startTime > $endTime && $endTime > 0)) {
            } else {
                if ($startTime) {
                    $qwhere .= ' AND timestamp>=FROM_UNIXTIME(' . $startTime . ')';
                }
                if ($endTime) {
                    $qwhere .= ' AND timestamp<=FROM_UNIXTIME(' . $endTime . ')';
                }
            }
            break;
        default:
            // No other classes handled
            break;
    }

    // Convert class member to local/global variable reference
    global $show_view_audits;
    if (!$show_view_audits) {
        $qwhere .= ' AND event_id !=' . db_input(Event::getIdByName('viewed'));
    }

    // Begin implementation merged from getPageNav
    $qfrom = '';
    $total = db_count("SELECT count(*) $qfrom $qwhere");

    // Preserve semantics: getQwhere originally returned $qwhere; getPageNav did not return anything.
    return $qwhere;
}
?>