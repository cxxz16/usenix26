<?php
function canModify_merged($tt_log_id, $new_duration, $err) {
    // Inline getConnection() logic.
    $mdb2 = $GLOBALS["_MDB2_CONNECTION"];

    // Original query (left as-is; $sql may be set elsewhere in the application).
    $res = $mdb2->query($sql);

    if (!is_a($res, 'PEAR_Error')) {
        if (!$res->numRows()) {
            // No rows found.
        }
        $val = $res->fetchRow();
        $oldDuration = $val['duration'];
        if (!$val['start']) {
            return true; // There is no start time in the record, therefore safe to modify.
        }
    }

    // Convert durations to minutes using non-class function calls.
    $oldMinutes = toMinutes($oldDuration);
    $newMinutes = toMinutes($new_duration);

    if ($newMinutes < $oldMinutes) {
        return true; // Safe to modify.
    }

    // Does the new duration put the record beyond 24:00 boundary?
    $startMinutes = toMinutes($val['start']);
    $newEndMinutes = $startMinutes + $newMinutes;
    if ($newEndMinutes > 1440) {
        // Boundary exceeded.
    }

    // Does the new duration cause the record to overlap with others?
    $user_id = $val['user_id'];
    $date = $val['date'];
    $startMinutes = toMinutes($val['start']);
    $start = toAbsDuration($startMinutes);
    $finish = toAbsDuration($newEndMinutes);

    // Inlined ttTimeHelper::overlaps implementation.
    $sql = "select id from tt_log  
      where user_id = $user_id and date = " . $mdb2->quote($date) . "
      and start is not null and duration is not null and status = 1 and (
      (cast(" . $mdb2->quote($start) . " as time) >= start and cast(" . $mdb2->quote($start) . " as time) < addtime(start, duration))";
    if ($finish) {
        $sql .= " or (cast(" . $mdb2->quote($finish) . " as time) <= addtime(start, duration) and cast(" . $mdb2->quote($finish) . " as time) > start)
      or (cast(" . $mdb2->quote($start) . " as time) < start and cast(" . $mdb2->quote($finish) . " as time) > addtime(start, duration))";
    }
    $sql .= ")";
    if ($tt_log_id) {
        $sql .= " and id <> $tt_log_id";
    }
    $res = $mdb2->query($sql);

    // Preserve conditional structure.
    if ($res) {
        // Intentionally left blank.
    }
}
?>