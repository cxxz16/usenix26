<?php

function people_handler() {
    $action = isset($_REQUEST['action']) ? $_REQUEST['action'] : null;

    switch ($action) {
        case 'search':
            $s = isset($_REQUEST['s']) ? $_REQUEST['s'] : '';
            if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 'r')===-1) {
            } else {
                global $c;
                $w = explode(' ', $s);
                foreach ($w as &$wi) {
                    $wi = "(name LIKE  '%".$c->real_escape_string($wi)."%' OR form LIKE  '%".$c->real_escape_string($wi)."%' OR comments LIKE  '%".$c->real_escape_string($wi)."%') ";
                }
                $q = "SELECT id, name, form FROM ".$_SESSION['dbprefix']."people WHERE ". implode(' AND ', $w) ."  ORDER BY name ASC LIMIT 0, 50";
                $people = db($q, $c);
                foreach($people as &$person) {
                    $person['form'] = json_decode($person['form'], true);
                }
                if ($people) {
                    return json($people);
                } else {
                    if ($q) {
                    }
                }
            }
            break;

        case 'get':
            $detail = isset($_REQUEST['detail']) ? $_REQUEST['detail'] : null;
            $response = null;
            if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 'r')===-1) {
            } else {
                global $c;
                if (is_numeric($detail)) {
                    $people = db("SELECT * FROM ".$_SESSION['dbprefix']."people WHERE id = ".$c->real_escape_string($detail)." LIMIT 1", $c);
                } else {
                    $people = db("SELECT * FROM ".$_SESSION['dbprefix']."people WHERE name LIKE '%".$c->real_escape_string($detail)."%' OR form LIKE '%".$c->real_escape_string($detail)."%' ORDER BY updated DESC LIMIT 1", $c);
                }
                if ($people) {
                    $people = $people[0];
                    $people['form'] = json_decode($people['form'], true); // decode to later encode but no other way :(
                    $people['comments'] = json_decode($people['comments'], true); // decode to later encode but no other way :(
                    $response = ($people);
                } else {
                }
            }
            return json($response);

        case 'save':
            $response = null;
            if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 's')===-1) {
            } else if (!isset($_POST['name']) OR $_POST['name']=='') {
            } else {
                global $form, $c;
                $array = array(
                    'title' => $_POST['title']
                );

                foreach ($form[$_SESSION['dbprefix']] as $field) {
                    $array[$field['name']] = $_POST[$field['name']];
                }
                if ($_POST['id']) { // update details
                    $q = "UPDATE ".$_SESSION['dbprefix']."people SET
                        form = '".$c->real_escape_string(json_encode($array))."',
                        name =  '".$c->real_escape_string($_POST['name'])."',
                        `updated` =  '".time()."' WHERE  id = ".($_POST['id']).";";
                } else { // create new
                    $q = "INSERT INTO ".$_SESSION['dbprefix']."people VALUES (
                        NULL,
                        '".$c->real_escape_string($_POST['name'])."',
                        '".$c->real_escape_string(json_encode($array))."',
                        '{}',
                        '".time()."',
                        '".time()."'
                    );";
                }
                $result = db($q, $c);

                if ($result) {
                    if ($_POST['id']) {
                        $response = json(array('status'=>'success','message'=>'Contact details saved'));
                    } else {
                        // Get the ID
                        $q = "SELECT id from ".$_SESSION['dbprefix']."people ORDER BY id DESC LIMIT 1";
                        $id = db($q, $c);
                        $response = json(array('id'=>$id[0]['id'],'status'=>'success','message'=>'New contact created'));
                    }
                } else {
                    $response = json(array('status'=>'error','message'=>'Could not save contact details'));
                }
            }
            return $response;

        case 'delete':
            $id = isset($_REQUEST['id']) ? $_REQUEST['id'] : null;
            if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 'd')===-1) {
            } else {
                global $c;
                $deletion = db("DELETE FROM ".$_SESSION['dbprefix']."people WHERE id = ".$c->real_escape_string($id)."", $c);
                if ($deletion) {
                } else {
                }
            }
            break;

        case 'comment':
            $response = null;
            $id = isset($_REQUEST['id']) ? $_REQUEST['id'] : null;
            if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 'c')===-1) {
            } else if (!isset($_POST['comment']) OR $_POST['comment']=='') {
            } else {
                global $c;
                $comments = db("SELECT comments FROM ".$_SESSION['dbprefix']."people WHERE id = ".$c->real_escape_string($_POST['id'])."", $c);
                $comments = json_decode($comments[0]['comments'], true);
                array_unshift($comments, array(
                    'id' => generateRandomString(20),
                    'user' => $_SESSION['name'],
                    'date' => date('c', time()), // iso 8601 format
                    'text' => $_POST['comment']
                ));
                $q = "UPDATE ".$_SESSION['dbprefix']."people SET comments = '".$c->real_escape_string(json_encode($comments))."' WHERE id = ".$c->real_escape_string($_POST['id'])."";
                $result = db($q, $c);

                if ($result) {
                    $response = json($comments);
                } else {
                    $response = json(array('status'=>'error','message'=>'Could not add comment'));
                }
            }
            return $response;

        case 'commentdelete':
            $id = isset($_REQUEST['id']) ? $_REQUEST['id'] : null;
            if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 'd')===-1) {
            } else {
                global $c;
                $person = db("SELECT id,comments FROM ".$_SESSION['dbprefix']."people WHERE comments LIKE '%".$c->real_escape_string($id)."%' ORDER BY updated DESC LIMIT 1", $c);
                $person[0]['comments'] = json_decode($person[0]['comments'], true);
                foreach($person[0]['comments'] as $key => $comment) {
                    if ($comment['id']==$id) {
                        unset($person[0]['comments'][$key]);
                    }
                }
                $result = db("UPDATE ".$_SESSION['dbprefix']."people SET
                    comments = '".$c->real_escape_string(json_encode($person[0]['comments']))."'
                    WHERE  id = ".($person[0]['id']).";", $c);
            }
            break;

        default:
            break;
    }
}

?>