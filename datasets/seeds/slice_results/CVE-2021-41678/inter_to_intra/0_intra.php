<?php
function process_staff_update() {
    if (isset($_REQUEST['custom_date_id']) && count($_REQUEST['custom_date_id']) > 0) {
        foreach ($_REQUEST['custom_date_id'] as $custom_id) {
            $_REQUEST['staff']['CUSTOM_' . $custom_id] = $_REQUEST['year_CUSTOM_' . $custom_id] . '-' . MonthFormatter($_REQUEST['month_CUSTOM_' . $custom_id]) . '-' . $_REQUEST['day_CUSTOM_' . $custom_id];
            $_POST['staff']['CUSTOM_' . $custom_id] = $_REQUEST['year_CUSTOM_' . $custom_id] . '-' . MonthFormatter($_REQUEST['month_CUSTOM_' . $custom_id]) . '-' . $_REQUEST['day_CUSTOM_' . $custom_id];
        }
    }
    if (clean_param($_REQUEST['modfunc'], PARAM_ALPHAMOD) == 'update') {
        if (count($_REQUEST['values']['SCHOOLS']) > 0) {
            $school_array = $_REQUEST['values']['SCHOOLS'];
            $cur_school = array_keys($school_array);
            if ($_REQUEST['staff_id'] == 'new') {
                $_REQUEST['staff']['CURRENT_SCHOOL_ID'] = $cur_school[0];
            } else {
                if ($cur_school[0]) {
                    $_REQUEST['staff_school']['CURRENT_SCHOOL_ID'] = $cur_school[0];
                }
            }
        }
        $password = md5($_REQUEST[staff][PASSWORD]);
        $ins_profile = $_REQUEST[staff][PROFILE];
        $res_pass_chk = DBQuery('SELECT * FROM login_authentication WHERE PASSWORD = \'' . $password . '\'');
        $num_pass = $res_pass_chk->num_rows;
        if (count($_POST['staff']) && (User('PROFILE') == 'admin' || User('PROFILE') == 'teacher' || basename($_SERVER['PHP_SELF']) == 'index.php') || $_REQUEST['ajax']) {
            if ($_REQUEST['staff_id'] && $_REQUEST['staff_id'] != 'new') {
                $this_school_RET_mod = DBGet(DBQuery("SELECT s.*,l.* FROM staff s,login_authentication l  WHERE l.USER_ID=s.STAFF_ID AND l.PROFILE_ID NOT IN (3,4) AND s.STAFF_ID=" . $_REQUEST[staff_id]));
                $this_school_mod = $this_school_RET_mod[1];
                $username = $this_school_mod['USERNAME'];
                $password = $this_school_mod['PASSWORD'];
                $this_school_RET = DBGet(DBQuery("SELECT * FROM staff_school_info   WHERE   STAFF_ID=" . $_REQUEST[staff_id]));
                $this_school = $this_school_RET[1];
                if (isset($_REQUEST['staff']['PROFILE']) && $_REQUEST['staff']['PROFILE'] != $profile_RET[1]['PROFILE_ID']) {
                    if ($_REQUEST['staff']['PROFILE'] == 'admin') {
                        $_REQUEST['staff']['PROFILE_ID'] = '1';
                    } elseif ($_REQUEST['staff']['PROFILE'] == 'teacher') {
                        $_REQUEST['staff']['PROFILE_ID'] = '2';
                    } elseif ($_REQUEST['staff']['PROFILE'] == 'parent') {
                        $_REQUEST['staff']['PROFILE_ID'] = '4';
                    }
                }
                if ($_REQUEST['staff']['USERNAME'] && $_REQUEST['staff']['USERNAME'] != $profile_RET[1]['USERNAME']) {
                    $existing_staff = DBGet(DBQuery('SELECT ssr.SYEAR FROM staff s,staff_school_relationship ssr WHERE s.STAFF_ID=ssr.STAFF_ID AND s.USERNAME=\'' . $_REQUEST['staff']['USERNAME'] . '\' AND ssr.SYEAR=(SELECT SYEAR FROM staff_school_relationship WHERE STAFF_ID=\'' . $_REQUEST[staff_id] . '\')'));
                    if (count($existing_staff)) {
                        BackPrompt('A user with that username already exists for the ' . $existing_staff[1]['SYEAR'] . ' school year. Choose a different username and try again.');
                    }
                }
                if ($_REQUEST['staff']) {
                    if ($_REQUEST['staff']['PHYSICAL_DISABILITY'] == 'N' && !isset($_REQUEST['staff']['DISABILITY_DESC'])) {
                        DBQuery('UPDATE staff SET DISABILITY_DESC=Null WHERE STAFF_ID=' . $_REQUEST[staff_id]);
                    }
                    if ($username == '' || $password == '' || $this_school['JOINING_DATE'] == '') {
                    }
                    foreach ($_REQUEST['staff'] as $column_name => $value) {
                        if ($column_name == 'BIRTHDATE' && $value != '') {
                            $value = date("Y-m-d", strtotime($value));
                        }
                        if ($column_name == 'SCHOOLS') {
                            continue;
                        }
                        if (strpos($column_name, "CUSTOM") == 0) {
                            $custom = DBGet(DBQuery("SHOW COLUMNS FROM staff WHERE FIELD='" . $column_name . "'"));
                            $custom = $custom[1];
                            $custom_id = str_replace("CUSTOM_", "", $column_name);
                            $custom_RET = DBGet(DBQuery("SELECT TITLE,TYPE,REQUIRED FROM staff_fields WHERE ID=" . $custom_id));
                            if ($custom_RET[1]['TYPE'] == 'multiple') {
                                $valueSize = count($value);
                                if ($valueSize == 0) {
                                }
                            } else {
                                $valueSize = trim($value);
                            }
                            if ($custom_RET[1]['TYPE'] == 'date') {
                                if ($value != '') {
                                    $dateValue = explode('-', $value);
                                    $value = $dateValue[2] . '-' . $dateValue[1] . '-' . $dateValue[0];
                                }
                            }
                            if ($custom['NULL'] == 'NO' && trim($valueSize) == '' && $custom['DEFAULT']) {
                                $value = $custom['DEFAULT'];
                            } elseif ($custom['NULL'] == 'NO' && (is_array($value) ? count($value) == 0 : trim($value) == '')) {
                                $custom_TITLE = DBGet(DBQuery("SELECT TITLE FROM staff_fields WHERE ID=" . $custom_id));
                                $custom_TITLE = $custom_TITLE[1]['TITLE'];
                                if ($custom_TITLE != '') {
                                    echo "<div class='alert alert-danger'>Unable to save data, because " . $custom_TITLE . ' is required.</div>';
                                } else {
                                    echo "<div class='alert alert-danger'>Unable to save data, because " . $custom_TITLE . ' is required.</div>';
                                }
                            } else {
                                $custom_id = str_replace("CUSTOM_", "", $column_name);
                                $m_custom_RET = DBGet(DBQuery("SELECT ID,TITLE,TYPE from staff_fields WHERE ID='" . $custom_id . "' AND TYPE='multiple'"));
                                if ($m_custom_RET) {
                                    foreach ($value as $m_custom_val) {
                                        if ($m_custom_val) {
                                            $str .= "||" . $m_custom_val;
                                        }
                                    }
                                    if ($str) {
                                        $value = $str . "||";
                                    } else {
                                        $value = '';
                                    }
                                }
                            }
                        }
                        if ($column_name == 'PASSWORD') {
                            if ($value != "") {
                                $sql .= "$column_name='" . str_replace("\'", "''", str_replace("`", "''", md5($value))) . "',";
                            }
                        }
                        if ($column_name == 'FIRST_NAME' || $column_name == 'LAST_NAME') {
                            if (stripos($_SERVER['SERVER_SOFTWARE'], 'linux')) {
                                $sql .= "$column_name='" . $value . " ',";
                            } else {
                                $sql .= "$column_name='" . $value . " ',";
                            }
                        } else {
                            if (stripos($_SERVER['SERVER_SOFTWARE'], 'linux')) {
                                $sql .= "$column_name='" . str_replace("'", "\'", str_replace("`", "''", $value)) . "',";
                            } else {
                                $sql .= "$column_name='" . str_replace("'", "''", str_replace("'`", "''", $value)) . "',";
                            }
                        }
                    }
                    $sql = substr($sql, 0, -1) . " WHERE STAFF_ID='$_REQUEST[staff_id]'";
                    if ((User('PROFILE') == 'admin' || User('PROFILE') == 'teacher') && $execute == 'yes' && $error != true) {
                        DBQuery($sql);
                        if (isset($flg_cp) && $flg_cp == 1) {
                            $chk_assoc_cp = DBGet(DBQuery('SELECT course_period_id,title,short_name from course_periods WHERE school_id=' . UserSchool() . ' AND syear=' . UserSyear() . ' and teacher_id=' . $_REQUEST[staff_id]));
                            $new_tec_name = DBGet(DBQuery("SELECT concat(first_name,' ',last_name)  as name FROM  staff  WHERE STAFF_ID=" . $_REQUEST[staff_id]));
                            $new_tec_name = $new_tec_name[1]['NAME'];
                            foreach ($chk_assoc_cp as $chk_assoc_cp_k => $chk_assoc_cp_v) {
                                $new_title = $chk_assoc_cp_v['SHORT_NAME'] . '-' . $new_tec_name;
                                $update_cp_title = DBQuery('UPDATE  course_periods SET TITLE=\'' . singleQuoteReplace('', '', $new_title) . '\' WHERE  course_period_id=' . $chk_assoc_cp_v['COURSE_PERIOD_ID']);
                            }
                        }
                        if ($_FILES['file']['name']) {
                            $stf_img_info = DBGet(DBQuery('SELECT * FROM staff WHERE STAFF_ID=' . $_REQUEST[staff_id] . ' AND IMG_NAME IS NOT NULL'));
                            if (count($stf_img_info) > 0) {
                                $upload->deleteOldImage($stf_img_info[1]['STAFF_ID']);
                            }
                        }
                    }
                }
            } else {
                if ($_REQUEST['staff']['PROFILE'] == 'admin') {
                    $_REQUEST['staff']['PROFILE_ID'] = '1';
                } elseif ($_REQUEST['staff']['PROFILE'] == 'teacher') {
                    $_REQUEST['staff']['PROFILE_ID'] = '2';
                } elseif ($_REQUEST['staff']['PROFILE'] == 'parent') {
                    $_REQUEST['staff']['PROFILE_ID'] = '4';
                }
                $existing_staff = DBGet(DBQuery("SELECT 'exists' FROM login_authentication WHERE USERNAME='" . $_REQUEST['staff']['USERNAME'] . "'"));
                $sql = "INSERT INTO staff ";
                $fields = 'CURRENT_SCHOOL_ID,';
                $values = UserSchool() . ',';
                if (count($_REQUEST['month_staff'])) {
                    foreach ($_REQUEST['month_staff'] as $column => $value) {
                        $_REQUEST['staff'][$column] = $_REQUEST['day_staff'][$column] . '-' . $_REQUEST['month_staff'][$column] . '-' . $_REQUEST['year_staff'][$column];
                        if ($_REQUEST['staff'][$column] == '--') {
                            $_REQUEST['staff'][$column] = '';
                        } elseif (!VerifyDate($_REQUEST['staff'][$column])) {
                            unset($_REQUEST['staff'][$column]);
                        }
                    }
                }
                foreach ($_REQUEST['staff'] as $column => $value) {
                    if ($column == 'BIRTHDATE' && $value != '') {
                        $value = date("Y-m-d", strtotime($value));
                    }
                    if ($column == 'SCHOOLS') {
                        continue;
                    }
                    if (strpos($column, "CUSTOM") == 0) {
                        $custom = DBGet(DBQuery("SHOW COLUMNS FROM staff WHERE FIELD='" . $column . "'"));
                        $custom = $custom[1];
                        if ($custom['NULL'] == 'NO' && trim($value) == '' && !$custom['DEFAULT']) {
                            $custom_id = str_replace("CUSTOM_", "", $column);
                            $custom_TITLE = DBGet(DBQuery("SELECT TITLE FROM staff_fields WHERE ID='" . $custom_id . "' "));
                            $custom_TITLE = $custom_TITLE[1]['TITLE'];
                        } else {
                            $custom_id = str_replace("CUSTOM_", "", $column);
                            $m_custom_RET = DBGet(DBQuery("SELECT ID,TITLE,TYPE from staff_fields WHERE ID='" . $custom_id . "' AND TYPE='multiple'"));
                            if ($m_custom_RET) {
                                $str = "";
                                foreach ($value as $m_custom_val) {
                                    if ($m_custom_val) {
                                        $str .= "||" . $m_custom_val;
                                    }
                                }
                                if ($str) {
                                    $value = $str . "||";
                                } else {
                                    $value = '';
                                }
                            }
                        }
                    }
                    if ($value) {
                        if ($column == 'FN') {
                            $column = 'FIRST_NAME';
                        } elseif ($column == 'LN') {
                            $column = 'LAST_NAME';
                        } elseif ($column == 'MN') {
                            $column = 'MIDDLE_NAME';
                        }
                        $fields .= $column . ',';
                        if ($column == 'FIRST_NAME' || $column == 'LAST_NAME') {
                            if (stripos($_SERVER['SERVER_SOFTWARE'], 'linux')) {
                                $values .= "'" . trim($value) . "',";
                            } else {
                                $values .= "'" . trim($value) . "',";
                            }
                        } else {
                            if (stripos($_SERVER['SERVER_SOFTWARE'], 'linux')) {
                                $values .= "'" . str_replace("'", "\'", $value) . "',";
                            } else {
                                $values .= "'" . str_replace("'", "''", $value) . "',";
                            }
                        }
                    }
                }
                $sql .= '(' . substr($fields, 0, -1) . ') values(' . substr($values, 0, -1) . ')';
                if ($error != true) {
                    DBQuery($sql);
                } else {
                }
            }
        }
    }
}
?>