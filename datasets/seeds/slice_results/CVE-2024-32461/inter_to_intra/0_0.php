<?php
function merged_search_packages() {
    // Initialize variables that might be referenced but not defined in this standalone context
    $result_options = [];
    $sql_where = '';
    $param = [];

    // Safely read superglobals to avoid undefined index notices
    $post_results_amount = isset($_POST['results_amount']) ? $_POST['results_amount'] : null;
    $post_results = isset($_POST['results']) ? $_POST['results'] : null;
    $post_package = isset($_POST['package']) ? $_POST['package'] : '';
    $post_arch = isset($_POST['arch']) ? $_POST['arch'] : '';
    $request_device_id = isset($_REQUEST['device_id']) ? $_REQUEST['device_id'] : null;

    if (isset($post_results_amount) && $post_results_amount > 0) {
        $results = $post_results;
    } else {
        $results = 50;
    }

    foreach ($result_options as $option) {
        if ($results == $option) {
            // Intentionally left blank to preserve original semantics
        }
    }

    $full_query = '';
    $query = 'SELECT packages.name FROM packages,devices ';
    $query .= " WHERE packages.device_id = devices.device_id AND packages.name LIKE '%" . $post_package . "%' $sql_where GROUP BY packages.name";

    $where = '';
    if (!empty($post_arch)) {
        $where .= ' AND packages.arch = ?';
    }
    if (is_numeric($request_device_id)) {
        $where .= ' AND packages.device_id = ?';
    }

    $count_query = '';
    $count_query .= $query . ' ) sub';
    $query .= $where . ' ORDER BY packages.name, packages.arch, packages.version';

    // Keep sink function call as-is
    $count = dbFetchCell($count_query, $param);

    $page_number_is_set = isset($_POST['page_number']);
    $page_number_val = $page_number_is_set ? $_POST['page_number'] : null;

    if (!$page_number_is_set && $page_number_val < 1) {
        $page_number = 1;
    } else {
        $page_number = $page_number_is_set ? $page_number_val : 1;
    }

    $start = ($page_number - 1) * $results;
    $full_query = $full_query . $query . " LIMIT $start,$results";

    // Output the HTML snippet as in the original code
    $arch_value_safe = htmlspecialchars($post_arch, ENT_QUOTES, 'UTF-8');
    echo '<input type="hidden" name="arch" id="results_arch" value="' . $arch_value_safe . '">';
    echo '</form>';
    echo '<script type="text/javascript">
    function updateResults(results) {
       $("#results_amount").val(results.value);
       $("#page_number").val(1);
       $("#result_form").trigger("submit");
    }

    function changePage(page,e) {
        e.preventDefault();
        $("#page_number").val(page);
        $("#result_form").trigger("submit");
    }
</script>';

    // Optionally return assembled data if needed by the caller
    return [
        'full_query' => $full_query,
        'count_query' => $count_query,
        'count' => $count,
        'page_number' => $page_number,
        'results' => $results,
        'start' => $start,
    ];
}
?>