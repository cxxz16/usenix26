<?php
function packages_search_merged() {
    // Determine number of results per page
    if (isset($_POST['results_amount']) && $_POST['results_amount'] > 0) {
        $results = isset($_POST['results']) ? $_POST['results'] : 50;
    } else {
        $results = 50;
    }

    // Validate results against available options if present
    if (isset($result_options) && is_array($result_options)) {
        foreach ($result_options as $option) {
            if ($results == $option) {
                // No-op: structure retained
            }
        }
    }

    // Build query components
    $full_query = '';
    $sql_where = isset($sql_where) ? $sql_where : '';
    $query = 'SELECT packages.name FROM packages,devices ';
    $query .= " WHERE packages.device_id = devices.device_id AND packages.name LIKE '%" . (isset($_POST['package']) ? $_POST['package'] : '') . "%' $sql_where GROUP BY packages.name";

    $where = '';
    $param = [];

    if (!empty($_POST['arch'])) {
        $where .= ' AND packages.arch = ?';
        $param[] = $_POST['arch'];
    }

    if (isset($_REQUEST['device_id']) && is_numeric($_REQUEST['device_id'])) {
        $where .= ' AND packages.device_id = ?';
        $param[] = $_REQUEST['device_id'];
    }

    // Count query and execution
    $count_query = '';
    $count_query .= $query . ' ) sub';
    $query .= $where . ' ORDER BY packages.name, packages.arch, packages.version';
    $count = dbFetchCell($count_query, $param);

    // Pagination handling
    if (!isset($_POST['page_number'])) {
        $page_number = 1;
    } elseif ($_POST['page_number'] < 1) {
        $page_number = 1;
    } else {
        $page_number = $_POST['page_number'];
    }

    $start = ($page_number - 1) * $results;
    $full_query = $full_query . $query . " LIMIT $start,$results";

    // Output the HTML elements preserved from original snippet
    echo '<input type="hidden" name="arch" id="results_arch" value="' . htmlspecialchars(isset($_POST['arch']) ? $_POST['arch'] : '') . '">';

    echo '<script type="text/javascript">
    function updateResults(results) {
       $(\'#results_amount\').val(results.value);
       $(\'#page_number\').val(1);
       $(\'#result_form\').trigger("submit");
    }

    function changePage(page,e) {
        e.preventDefault();
        $(\'#page_number\').val(page);
        $(\'#result_form\').trigger("submit");
    }
    </script>';

    // Return computed values for potential external use
    return [
        'results' => $results,
        'query' => $query,
        'full_query' => $full_query,
        'count_query' => $count_query,
        'count' => $count,
        'page_number' => $page_number,
        'start' => $start,
        'params' => $param,
    ];
}
?>