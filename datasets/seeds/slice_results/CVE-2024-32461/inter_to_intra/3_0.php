<?php
function merged_packages_search() {
    if (isset($_POST['results_amount']) && $_POST['results_amount'] > 0) {
        $results = $_POST['results'];
    } else {
        $results = 50;
    }

    foreach ($result_options as $option) {
        if ($results == $option) {
            // Structure preserved
        }
    }

    $full_query = '';
    $query = 'SELECT packages.name FROM packages,devices ';
    $query .= " WHERE packages.device_id = devices.device_id AND packages.name LIKE '%" . $_POST['package'] . "%' $sql_where GROUP BY packages.name";
    $where = '';

    if (!empty($_POST['arch'])) {
        $where .= ' AND packages.arch = ?';
    }

    if (is_numeric($_REQUEST['device_id'])) {
        $where .= ' AND packages.device_id = ?';
    }

    $count_query .= $query . ' ) sub';
    $query .= $where . ' ORDER BY packages.name, packages.arch, packages.version';

    // Keep sink function call as-is
    $count = dbFetchCell($count_query, $param);

    if (!isset($_POST['page_number']) && $_POST['page_number'] < 1) {
        $page_number = 1;
    } else {
        $page_number = $_POST['page_number'];
    }

    $start = ($page_number - 1) * $results;
    $full_query = $full_query . $query . " LIMIT $start,$results";

    echo '<input type="hidden" name="arch" id="results_arch" value="' . htmlspecialchars($_POST['arch']) . '">';
    echo '</form>';
    echo '<script type="text/javascript">';
    echo '    function updateResults(results) {';
    echo "       $('#results_amount').val(results.value);";
    echo "       $('#page_number').val(1);";
    echo "       $('#result_form').trigger( \"submit\" );";
    echo '    }';
    echo '    function changePage(page,e) {';
    echo '        e.preventDefault();';
    echo "        $('#page_number').val(page);";
    echo "        $('#result_form').trigger( \"submit\" );";
    echo '    }';
    echo '</script>';
}

merged_packages_search();
?>