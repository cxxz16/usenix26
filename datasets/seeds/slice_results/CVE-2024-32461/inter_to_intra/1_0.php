<?php
function merged_packages_search() {
    // Use globals that may be defined elsewhere in the application
    global $result_options, $sql_where, $param;

    if (isset($_POST['results_amount']) && $_POST['results_amount'] > 0) {
        $results = $_POST['results'];
    } else {
        $results = 50;
    }

    if (is_array($result_options)) {
        foreach ($result_options as $option) {
            if ($results == $option) {
                // No operation; structure retained
            }
        }
    }

    $full_query = '';
    $query = 'SELECT packages.name FROM packages,devices ';
    $query .= " WHERE packages.device_id = devices.device_id AND packages.name LIKE '%" . (isset($_POST['package']) ? $_POST['package'] : '') . "%' " . (isset($sql_where) ? $sql_where : '') . " GROUP BY packages.name";
    $where = '';
    if (! empty($_POST['arch'])) {
        $where .= ' AND packages.arch = ?';
    }
    if (isset($_REQUEST['device_id']) && is_numeric($_REQUEST['device_id'])) {
        $where .= ' AND packages.device_id = ?';
    }
    $count_query = '';
    $count_query .= $query . ' ) sub';
    $query .= $where . ' ORDER BY packages.name, packages.arch, packages.version';
    $count = dbFetchCell($count_query, isset($param) ? $param : null);

    if (! isset($_POST['page_number']) && $_POST['page_number'] < 1) {
        $page_number = 1;
    } else {
        $page_number = isset($_POST['page_number']) ? $_POST['page_number'] : 1;
    }

    $start = ($page_number - 1) * $results;
    $full_query = $full_query . $query . " LIMIT $start,$results";

    echo '<input type="hidden" name="arch" id="results_arch" value="' . htmlspecialchars(isset($_POST['arch']) ? $_POST['arch'] : '') . '">';
    echo '</form>';
    echo '<script type="text/javascript">
        function updateResults(results) {
           $("#results_amount").val(results.value);
           $("#page_number").val(1);
           $("#result_form").trigger("submit");
        }

        function changePage(page,e) {
            e.preventDefault();
            $("#page_number").val(page);
            $("#result_form").trigger("submit");
        }
    </script>';
}
?>