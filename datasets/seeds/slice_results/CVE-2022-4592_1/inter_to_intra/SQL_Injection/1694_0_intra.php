<?php
// Call Relations: []

// File: /home/xinchu/research/php-vd/PHPJoy/test_dataset_projects/crmx-CVE-2022-4592-e5585639df45be373d120a57d83ef2891bbfe539/index.php

function comment($id) {
	if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 'c')===-1) {
	} else if (!isset($_POST['comment']) OR $_POST['comment']=='') {
	} else {
		global $c;
		$comments = db("SELECT comments FROM ".$_SESSION['dbprefix']."people WHERE id = ".$c->real_escape_string($_POST['id'])."", $c);
		$comments = json_decode($comments[0]['comments'], true);
		array_unshift($comments, array(
			'id' => generateRandomString(20),
			'user' => $_SESSION['name'],
			'date' => date('c', time()), // iso 8601 format
			'text' => $_POST['comment']
		));
		$q = "UPDATE ".$_SESSION['dbprefix']."people SET comments = '".$c->real_escape_string(json_encode($comments))."' WHERE id = ".$c->real_escape_string($_POST['id'])."";
		$result = db($q, $c);

		if ($result) {
			$response = json($comments);
		} else {
			$response = json(array('status'=>'error','message'=>'Could not add comment'));
		}
	}
}
?>