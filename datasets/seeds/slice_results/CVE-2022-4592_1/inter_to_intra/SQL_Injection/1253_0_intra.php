<?php
function save() {
	if (!isset($_SESSION['level']) OR strpos($_SESSION['level'], 's')===-1) {
	} else if (!isset($_POST['name']) OR $_POST['name']=='') {
	} else {

		global $form, $c;
		$array = array(
			'title' => $_POST['title']
		);

		foreach ($form[$_SESSION['dbprefix']] as $field) {
			$array[$field['name']] = $_POST[$field['name']];
		}
		//var_dump($array);
		if ($_POST['id']) { // update details
			$q = "UPDATE ".$_SESSION['dbprefix']."people SET
				form = '".$c->real_escape_string(json_encode($array))."',
				name =  '".$c->real_escape_string($_POST['name'])."',
				`updated` =  '".time()."' WHERE  id = ".($_POST['id']).";";
		} else { // create new
			$q = "INSERT INTO ".$_SESSION['dbprefix']."people VALUES (
				NULL,
				'".$c->real_escape_string($_POST['name'])."',
				'".$c->real_escape_string(json_encode($array))."',
				'{}',
				'".time()."',
				'".time()."'
			);";
		}
		//var_dump($q);
		$result = db($q, $c);

		if ($result) {
			if ($_POST['id']) {
				$response = json(array('status'=>'success','message'=>'Contact details saved'));
			} else {
				// Get the ID
				$q = "SELECT id from ".$_SESSION['dbprefix']."people ORDER BY id DESC LIMIT 1";
				$id = db($q, $c);
				$response = json(array('id'=>$id[0]['id'],'status'=>'success','message'=>'New contact created'));
			}
		} else {
			$response = json(array('status'=>'error','message'=>'Could not save contact details'));
		}
	}
}
?>