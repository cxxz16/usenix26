<?php
header('Content-Type: application/json');

function addHighscore() {
	$name = isset($_POST['name']) ? $_POST['name'] : "";
	$score = isset($_POST['score']) ? $_POST['score'] : 0;
	$level = isset($_POST['level']) ? $_POST['level'] : 0;

	$db = new SQLite3('pacman.db');
	$date = date('Y-m-d h:i:s', time());
	createDataBase($db);
	$ref = isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : "";
	$ua = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : "";
	$remA = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : "";
	$remH = isset($_SERVER['REMOTE_HOST']) ? $_SERVER['REMOTE_HOST'] : "";
	$ref_assert = preg_match('/http(s)?:\/\/.*' . $hostdomain . '/', $ref) > 0;
	$ua_assert = ($ua != "");
	$cheater = 0;
	if (!$ref_assert || !$ua_assert) {
		$cheater = 1;
	}
	if ($level < 1 || $level > 10) {
		$cheater = 1;
	} else if (($score / $level) > $maxlvlpoints) {
		$cheater = 1;
	}
	$name_clean = htmlspecialchars($name);
	$score_clean = htmlspecialchars($score);
	$db->exec('INSERT INTO highscore (name, score, level, date, log_referer, log_user_agent, log_remote_addr, log_remote_host, cheater) '
		. 'VALUES ("' 
			. $name . '", ' 
			. $score . ', ' 
			. $level . ', "' 
			. $date . '", "' 
			. $ref .'", "'
			. $ua . '", "'
			. $remA .'", "'
			. $remH . '", "'
			. $cheater
		.'")'
	);
}

if (isset($_POST['action'])) {
	switch ($_POST['action']) {
		case 'add':
			if (isset($_POST['name']) || isset($_POST['score']) || isset($_POST['level'])) {
				echo addHighscore();
			}
			break;
	}
} else if (isset($_GET['action'])) {
} else {
	echo "define action to call";
}