<?php
function merged_init_and_process(&$tplanMgr)
{
  // init_args logic
  $args = new stdClass();
  $args->show_help = (isset($_REQUEST['level']) && $_REQUEST['level'] == 'testproject');
  $args->tproject_id = intval(isset($_REQUEST['tproject_id']) ? $_REQUEST['tproject_id'] : $_SESSION['testprojectID']);
  $args->tplan_id = intval(isset($_REQUEST['tplan_id']) ? $_REQUEST['tplan_id'] : $_SESSION['testplanID']);
  $args->node_type = isset($_REQUEST['level']) ? $_REQUEST['level'] : OFF;
  $args->node_id = isset($_REQUEST['id']) ? $_REQUEST['id'] : ERROR;
  if (isset($_REQUEST['urgency'])) {
    $args->urgency_tc = $_REQUEST['urgency'];
  }
  $args->treeFormToken = isset($_REQUEST['form_token']) ? $_REQUEST['form_token'] : 0;

  // doProcess logic
  if ($args->urgency != OFF) {
    $userFeedback['type'] = $tplanMgr->setSuiteUrgency($args->tplan_id, $args->node_id, $args->urgency);
    $userFeedback['message'] = lang_get(($userFeedback['type'] == OK) ? "feedback_urgency_ok" : "feedback_urgency_fail");
  }

  if (isset($args->urgency_tc)) {
    foreach ($args->urgency_tc as $id => $urgency) {
      // setTestUrgency logic (keeping sink call as-is)
      $sql = " UPDATE {$tplanMgr->tables['testplan_tcversions']} SET urgency={$urgency} " .
             " WHERE testplan_id=" . $tplanMgr->db->prepare_int($args->tplan_id) .
             " AND tcversion_id=" . $tplanMgr->db->prepare_int($id);
      $tplanMgr->db->exec_query($sql);
    }
  }

  // preserve original behavior (no explicit return in doProcess)
  return isset($userFeedback) ? $userFeedback : null;
}