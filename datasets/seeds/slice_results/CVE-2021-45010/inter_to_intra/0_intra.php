<?php
function tinyfilemanager_upload_handler() {
    global $allowed, $ds, $override_file_name;

    if (!empty($_FILES) && !FM_READONLY) {
        $f = $_FILES;
        $path = FM_ROOT_PATH;
        if (FM_PATH != '') {
            $path .= '/' . FM_PATH;
        }
        $filename = $f['file']['name'];
        $tmp_name = $f['file']['tmp_name'];
        $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        $isFileAllowed = ($allowed) ? in_array($ext, $allowed) : true;
        if (!fm_isvalid_filename($filename) && !fm_isvalid_filename($_REQUEST['fullpath'])) {
        }
        $targetPath = $path . $ds;
        if (is_writable($targetPath)) {
            $fullPath = $path . '/' . $_REQUEST['fullpath'];
            $folder = substr($fullPath, 0, strrpos($fullPath, "/"));
            if (file_exists($fullPath) && !$override_file_name) {
                $ext_1 = $ext ? '.' . $ext : '';
                $fullPath = str_replace($ext_1, '', $fullPath) . '_' . date('ymdHis') . $ext_1;
            }
            if (!is_dir($folder)) {
                mkdir($folder, 0777, true);
            }
            if (empty($f['file']['error']) && !empty($tmp_name) && $tmp_name != 'none' && $isFileAllowed) {
                if (move_uploaded_file($tmp_name, $fullPath)) {
                } else {
                }
            }
        } else {
        }
    }
}
?>